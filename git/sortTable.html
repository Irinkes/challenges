<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <style>
            .wrapper {
                max-width:1000px;
                margin:5px auto;
            }
            table {
                border-spacing: 0;
                border:none !important;

            }
            thead tr:first-child{
                background: #ccc;
            }
            td, th{
                border:1px solid #000;
                padding: 5px;
            }
            .sort-btn{
                width: 0;
                height: 0;
                border-left: 10px solid transparent;
                border-right: 10px solid transparent;
                margin-left:10px;
                margin-right:10px;
                position: relative;
                cursor: pointer;
            }
            .sort-btn-down {
                border-top: 10px solid red;
                bottom: -15px;
            }
            .sort-btn-up {
                border-bottom: 10px solid red;
                bottom: 13px;
            }

            .inputs {
                margin-top:10px;
                display: none;
            }
            .inputs input[type='text'] {
                padding: 8px !important;
                margin-right:10px;
                display: inline!important;;
                width: auto!important;;
                height: auto!important;;
            }
            input.error-field {
                border-color: #a94442;
                box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
            }
            label.married {
                display: inline-block;
                margin-top:5px;
                margin-bottom: 15px;
                font-weight: normal;
            }
            .married input{
                display: inline-block;
                vertical-align: top;
            }
            .error-msg {
                display: none;
                color: red;
            }
            .delete{
                cursor: pointer;
                border:none !important;
                padding-left:10px;
                color: red;

            }
            .highlight {
                cursor: pointer;
                border:none !important;
                padding-left:10px;
                color: forestgreen;
                width: 200px;
                position: relative;

            }
            .highlight:hover .color-pallette{
                display: block;
            }

            .no-updates-popup {
                position: fixed;
                border: 1px solid #ccc;
                width: 600px;
                display: none;
                top: 10%;
                background: #fff;
                left: 50%;
                margin-left: -300px;
                padding: 10px;
            }
            .color-pallette {
                background: #fff;
                width: 90px;
                padding: 5px;
                position: absolute;
                right: 0;
                bottom: 0;
                display: none;
            }
            .pick-color {
                width: 20px;
                height:20px;
                display: inline-block;
                margin-right: 8px;
            }
            .pick-pink {
                background: hotpink;
                margin-right: 0 !important;
            }
            .pick-green {
                background: darkgreen;
            }
            .pick-yellow {
                background: yellow;
            }
        </style>
    </head>
    <body>
    <div class="wrapper" id="wrapper">
        <table id="table" class="table table-bordered">
            <thead>
                <tr>
                    <th>Name<span class="sort-btn sort-btn-up" id="names-col" data-type="abc"></span></th>
                    <th>Job title<span class=" sort-btn sort-btn-up" id="jobtitle-col" data-type="abc"></span></th>
                    <th>Age<span class="sort-btn sort-btn-up" data-type="num" id="age-col"></span></th>
                    <th>Married<span class="sort-btn sort-btn-up" data-type="abc" id="married-col"></span></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="name">Mark</td>
                    <td class="job">Javascript programmer</td>
                    <td class="age">18</td>
                    <td class="married">Yes</td>
                    <td class="delete" id="0">Delete</td>
                    <td class="highlight">Highlight <div class="color-pallette"><div class="pick-color pick-green"></div><div class="pick-color pick-yellow"></div><div class="pick-color pick-pink"></div></div></td>
                </tr>
                <tr>
                    <td class="name">Leo</td>
                    <td class="job">Full-stack developer</td>
                    <td class="age">16</td>
                    <td class="married">No</td>
                    <td class="delete" id="1">Delete</td>
                    <td class="highlight">Highlight <div class="color-pallette"><div class="pick-color pick-green"></div><div class="pick-color pick-yellow"></div><div class="pick-color pick-pink"></div></div></td>
                </tr>
                <tr>
                    <td class="name">Kiera</td>
                    <td class="job">Marketing sales manager</td>
                    <td class="age">38</td>
                    <td class="married">Yes</td>
                    <td class="delete" id="2">Delete</td>
                    <td class="highlight">Highlight <div class="color-pallette"><div class="pick-color pick-green"></div><div class="pick-color pick-yellow"></div><div class="pick-color pick-pink"></div></div></td>
                </tr>
                <tr>
                    <td class="name">Natasha</td>
                    <td class="job">HR manager</td>
                    <td class="age">25</td>
                    <td class="married">No</td>
                    <td class="delete" id="3">Delete</td>
                    <td class="highlight">Highlight <div class="color-pallette"><div class="pick-color pick-green"></div><div class="pick-color pick-yellow"></div><div class="pick-color pick-pink"></div></div></td>
                </tr>
                <tr>
                    <td class="name">Sonya</td>
                    <td class="job">Financial director</td>
                    <td class="age">29</td>
                    <td class="married">Yes</td>
                    <td class="delete" id="4">Delete</td>
                    <td class="highlight">Highlight <div class="color-pallette"><div class="pick-color pick-green"></div><div class="pick-color pick-yellow"></div><div class="pick-color pick-pink"></div></div></td>
                </tr>
                <tr>
                    <td class="name">Kevin</td>
                    <td class="job">Electrician</td>
                    <td class="age">30</td>
                    <td class="married">Yes</td>
                    <td class="delete" id="5">Delete</td>
                    <td class="highlight">Highlight <div class="color-pallette"><div class="pick-color pick-green"></div><div class="pick-color pick-yellow"></div><div class="pick-color pick-pink"></div></div></td>
                </tr>
                <tr>
                    <td class="name">Victoria</td>
                    <td class="job">HR manager</td>
                    <td class="age">19</td>
                    <td class="married">No</td>
                    <td class="delete" id="6">Delete</td>
                    <td class="highlight">Highlight <div class="color-pallette"><div class="pick-color pick-green"></div><div class="pick-color pick-yellow"></div><div class="pick-color pick-pink"></div></div></td>
                </tr>
                <tr>
                    <td class="name">Thomas</td>
                    <td class="job">Head of Marketing department</td>
                    <td class="age">39</td>
                    <td class="married">Yes</td>
                    <td class="delete" id="7">Delete</td>
                    <td class="highlight">Highlight <div class="color-pallette"><div class="pick-color pick-green"></div><div class="pick-color pick-yellow"></div><div class="pick-color pick-pink"></div></div></td>
                </tr>
                <tr>
                    <td class="name">Elizabeth</td>
                    <td class="job">Backend developer</td>
                    <td class="age">50</td>
                    <td class="married">Yes</td>
                    <td class="delete" id="8">Delete</td>
                    <td class="highlight">Highlight <div class="color-pallette"><div class="pick-color pick-green"></div><div class="pick-color pick-yellow"></div><div class="pick-color pick-pink"></div></div></td>
                </tr>
                <tr>
                    <td class="name">Moreen</td>
                    <td class="job">Pizzamaker</td>
                    <td class="age">16</td>
                    <td class="married">No</td>
                    <td class="delete" id="9">Delete</td>
                    <td class="highlight">Highlight <div class="color-pallette"><div class="pick-color pick-green"></div><div class="pick-color pick-yellow"></div><div class="pick-color pick-pink"></div></div></td>
                </tr>
            </tbody>
        </table>
        <div class="inputs" id="inputs">
            <input type="text" placeholder="Name" name="name" class="form-control"/>
            <input type="text" placeholder="Job title" name="jobtitle" class="form-control"/>
            <input type="text" placeholder="Age" name="age" class="form-control"/>
            <label class="married">
                <input type="checkbox" name="married"/>
                Married
            </label>
        </div>
        <div class="error-msg" id="error">
            Please check data you inserted
        </div>

        <a href="#" class="btn btn-info btn-lg add-btn" id="addbtn">
            <span class="glyphicon glyphicon-plus"></span> Add employee
        </a>
        <a href="#" class="btn btn-success btn-lg add-btn" id="uploadbtn">
            <span class="glyphicon glyphicon-plus"></span> Upload new employees
        </a>
        <div class="no-updates-popup" id="updates-popup">
            <!--<h3>It's 12.11 am 18/11/2017</h3>-->
            <!--<p>There are no new employees at this time.</p>-->
            <h3>No updates</h3>
        </div>
    </div>
        <script>
            function uploadData() {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", 'http://localhost:8080/employee', true);
                xhr.send();
                xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status==200){
                    console.log('responseText: ' + xhr.responseText);
                    try{
                        document.getElementById('uploadbtn').textContent = 'Upload new employees';
                        var data=JSON.parse(xhr.responseText);

                        addData(data);
                    } catch (err) {
                        console.log(err.message + " in " + xhr.responseText);
                        return;
                    }
                    }
                }
                function addData(data){//
                    console.log()
                   if(data.length>0) {
                       var tbody = table.getElementsByTagName('tbody')[0];
                       for (i = 0; i < data.length; i++) {
                           var tr = document.createElement('tr');

                           var deleteTd = document.createElement('td');
                           deleteTd.innerHTML = 'Delete';
                           deleteTd.className = 'delete';
                           deleteTd.setAttribute('id', data[i].id);

                           var pallette = "<div class=\"color-pallette\">" +
                               "<div class=\"pick-color pick-green\"></div>" +
                               "<div class=\"pick-color pick-yellow\"></div>" +
                               "<div class=\"pick-color pick-pink\"></div>" +
                               "</div>"

                           var highLightTd = document.createElement('td');
                           highLightTd.innerHTML = 'Highlight' + pallette;
                           highLightTd.className = 'highlight';



                           delete data[i].id;
                           for (key in data[i]) {
                               var td = document.createElement('td');
                               if (key === 'married') {
                                   if (data[i][key] === true) {
                                       td.innerHTML = 'Yes';
                                   } else {
                                       td.innerHTML = 'No';
                                   }
                               }

                               else {
                                   td.innerHTML = data[i][key];
                               }

                               tr.appendChild(td);
                               tr.appendChild(deleteTd);
                               tr.appendChild(highLightTd);
                           }

                           tbody.appendChild(tr);
                       }
                   } else{
                       document.getElementById('updates-popup').style.display='block';
                   }
                }

                document.getElementById('uploadbtn').textContent = 'Uploading...';

            }
            function deleteFromAPI(id) {
                var xhr = new XMLHttpRequest();
                xhr.open("DELETE", 'http://localhost:8080/employee/'+id, true);
                xhr.send();

                xhr.setRequestHeader('Accept', 'application/json');

                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        console.log('responseText: ' + xhr.responseText);
                        try {
                            var data = JSON.parse(xhr.responseText);
                            console.log(data);
                        } catch (err) {
                            console.log(err.message + " in " + xhr.responseText);
                            return;
                        }
                    }
                }
            }
            function sortColumns(){
                var tbody = table.getElementsByTagName('tbody')[0];
                var rowArray = [].slice.call(tbody.rows);
                var compareRows;
                var pallette = "<div class=\"color-pallette\">" +
                    "<div class=\"pick-color pick-green\"></div>" +
                    "<div class=\"pick-color pick-yellow\"></div>" +
                    "<div class=\"pick-color pick-pink\"></div>" +
                    "</div>"

                /*Удаление строк*/
                if(event.target.classList.contains('delete')){
                    var id = event.target.getAttribute('id');
                    deleteFromAPI(id);
                     event.target.parentNode.remove();

                }


                /*Зеленый */
                else if(event.target.classList.contains('pick-green')) {
                    var td = event.target.parentNode.parentNode.parentNode.children;

                    for(i=0;i<td.length-2;i++) {
                        if(!(td[i].classList.contains('success'))) {
                            td[i].classList.add('success');
                        }

                    }
                    if(td[0].classList.contains('success')) {
                        event.target.parentNode.parentNode.classList.add('remove-highlight');
                        event.target.parentNode.parentNode.innerHTML = "Remove highlighting";
                    }

                }

                /*Желтый*/
                else if(event.target.classList.contains('pick-yellow')) {
                    var td = event.target.parentNode.parentNode.parentNode.children;

                    for(i=0;i<td.length-2;i++) {
                        if(!(td[i].classList.contains('warning'))) {
                            td[i].classList.add('warning');
                        }

                    }
                    if(td[0].classList.contains('warning')) {
                        event.target.parentNode.parentNode.classList.add('remove-highlight');
                        event.target.parentNode.parentNode.innerHTML = "Remove highlighting";
                    }

                }

                /*Красный*/
                else if(event.target.classList.contains('pick-pink')) {
                    var td = event.target.parentNode.parentNode.parentNode.children;

                    for(i=0;i<td.length-2;i++) {
                        if(!(td[i].classList.contains('danger'))) {
                            td[i].classList.add('danger');
                        }

                    }
                    if(td[0].classList.contains('danger')) {
                        event.target.parentNode.parentNode.classList.add('remove-highlight');
                        event.target.parentNode.parentNode.innerHTML = "Remove highlighting";
                    }

                }
                /*Remove highlighting */
                else if(event.target.classList.contains('remove-highlight')) {
                    var td = event.target.parentNode.children;
                    console.log(td);
                    for(i=0;i<td.length-2;i++) {
                        if(td[i].classList.contains('success')){
                            td[i].classList.remove('success');
                            event.target.innerHTML="Highlight"+pallette;
                        }
                       else if(td[i].classList.contains('warning')){
                            td[i].classList.remove('warning');
                            event.target.innerHTML="Highlight"+pallette;
                        }
                        else if(td[i].classList.contains('danger')){
                            td[i].classList.remove('danger');
                            event.target.innerHTML="Highlight"+pallette;
                        }
                    }
                }




                else if(event.target.tagName==='TH' || event.target.tagName==='SPAN') {
                    var cellindex;
                    var attr;
                    console.log(event.target.tagName);
                    if(event.target.tagName==='TH') {
                        cellindex = event.target.cellIndex;
                        sortColHeader = event.target.childNodes[1];
                        attr = sortColHeader.getAttribute('data-type');
                    }
                    else if(event.target.tagName==='SPAN') {
                        cellindex = event.target.parentNode.cellIndex;
                        sortColHeader = event.target;
                        attr = event.target.getAttribute('data-type');

                    }

                    if(attr==='abc'){
                        compareRows = function (rowA, rowB) {
                            return rowA.cells[cellindex].innerHTML > rowB.cells[cellindex].innerHTML;
                        }
                    }
                    else if(attr==='num'){
                        compareRows = function (rowA, rowB) {
                            return rowA.cells[sortColHeader.parentNode.cellIndex].innerHTML - rowB.cells[sortColHeader.parentNode.cellIndex].innerHTML;
                        }
                    }

                    if(!(sortColHeader.classList.contains('sort-btn-down'))) {

                        rowArray = rowArray.sort(compareRows);
                        table.removeChild(tbody);
                        for(i=0;i<rowArray.length;i++) {
                            tbody.appendChild(rowArray[i]);
                        }
                        table.appendChild(tbody);
                        sortColHeader.classList.remove('sort-btn-up');
                        sortColHeader.classList.add('sort-btn-down');

                    }
                    else {
                        rowArray = rowArray.reverse();
                        table.removeChild(tbody);
                        for(i=0;i<rowArray.length;i++) {
                            tbody.appendChild(rowArray[i]);
                        }
                        table.appendChild(tbody)
                        sortColHeader.classList.remove('sort-btn-down');
                        sortColHeader.classList.add('sort-btn-up');
                    }
                }
                else {
                    return;
                }

            }
            function validateInputs(inputs) {
                for(i=0;i<inputs.length-1;i++) {
                    if(inputs[i].value.length===0) {
                        inputs[i].classList.add('error-field');
                        return false;
                    }
                }
                if(isNaN(parseInt(inputs[2].value)) || parseInt(inputs[2].value)<0) {
                    inputs[2].classList.add('error-field');
                    return false;
                }

                return true;
            }
            function addRow(){
                var addbtn = document.querySelector("#addbtn");
                var inputs = document.querySelector("#inputs");

                if(!(addbtn.classList.contains('addToTable'))) {
                    inputs.style.display='block';
                    addbtn.classList.add('addToTable');
                }
                else {
                    var tbody = table.getElementsByTagName('tbody')[0];
                    var inputValues=[];
                    for(i=0; i<inputs.getElementsByTagName('input').length;i++) {
                        if(inputs.getElementsByTagName('input')[i].type==='checkbox') {
                            if(inputs.getElementsByTagName('input')[i].checked){
                                inputValues[i] = 'Yes';
                            }
                            else{
                                inputValues[i] = 'No';
                            }
                        }
                        else{
                            inputValues[i] = inputs.getElementsByTagName('input')[i].value;
                        }

                    }
                    console.log(inputValues);
                    var validation = validateInputs(inputs.getElementsByTagName('input'));

                    if(validation) {
                        var tr = document.createElement('tr');
                        var newtd = [];
                        var deleteTd = document.createElement('td');
                        deleteTd.innerHTML = 'Delete';
                        deleteTd.className='delete';
                        var highLightTd = document.createElement('td');
                        var pallette = "<div class=\"color-pallette\">" +
                            "<div class=\"pick-color pick-green\"></div>" +
                            "<div class=\"pick-color pick-yellow\"></div>" +
                            "<div class=\"pick-color pick-pink\"></div>" +
                            "</div>"
                        highLightTd.innerHTML = 'Highlight'+pallette;
                        highLightTd.className='highlight';

                        for(i=0;i<inputs.getElementsByTagName('input').length;i++) {
                            if(inputs.getElementsByTagName('input')[i].classList.contains('error-field')) {
                                inputs.getElementsByTagName('input')[i].classList.remove('error-field');
                            }
                            newtd[i]=document.createElement('td');
                            newtd[i].innerHTML = inputValues[i];
                            tr.appendChild(newtd[i]);
                        }
                        tr.appendChild(deleteTd);
                        tr.appendChild(highLightTd);
                        tbody.appendChild(tr);

                        for(i=0;i<inputs.getElementsByTagName('input').length;i++) {
                            inputs.getElementsByTagName('input')[i].value='';
                        }
                        document.querySelector('#error').style.display='none';
                    }
                    else{
                        document.querySelector('#error').style.display='block';
                    }

                    addApi(inputValues);
                }



            }
            function addApi(dataArray) {
                var xhr = new XMLHttpRequest();
                if(dataArray[3]==='Yes') {
                    dataArray[3] = true;
                }
                else{
                    dataArray[3] = false;
                }
                var body = '{ \
                   "age":'+ encodeURIComponent(dataArray[2])+ ', \
                   "jobTitle":"'+encodeURIComponent(dataArray[1]) +'", \
                   "married":'+encodeURIComponent(dataArray[3])+', \
                   "name":"'+encodeURIComponent(dataArray[0])+'" \
                 }'

                xhr.open("POST", 'http://localhost:8080/employee', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(body);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        console.log('responseText: ' + xhr.responseText);
                        try {
                            var data = JSON.parse(xhr.responseText);
                            console.log(data);
                        } catch (err) {
                            console.log(err.message + " in " + xhr.responseText);
                            return;
                        }
                    }
                }
            }

            table.addEventListener('click',sortColumns);
            addbtn.addEventListener('click',addRow);
//            addbtn.addEventListener('click', addApi);
            uploadbtn.addEventListener('click', uploadData);
//


        </script>
    </body>
</html>